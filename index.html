<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Sandbox ‚Äî Control Mode</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111824;
      --panel2:#0f1620;
      --text:#e7eef7;
      --muted:#9fb0c3;
      --line:#223044;
      --good:#3ddc97;
      --bad:#ff5b6e;
      --warn:#ffcf5b;
      --accent:#64b5ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 10% 10%, #101a2a 0%, var(--bg) 45%) fixed;
      color:var(--text);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,24,36,.85), rgba(11,15,20,.55));
      position:sticky; top:0; z-index:3;
      backdrop-filter: blur(8px);
    }
    header .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1400px; margin:0 auto;
    }
    .title{
      display:flex; flex-direction:column; gap:2px;
    }
    .title h1{
      font-size:16px; margin:0; font-weight:700; letter-spacing:.2px;
    }
    .title .sub{
      font-size:12px; color:var(--muted);
    }
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px;
      background: rgba(17,24,36,.75);
      border:1px solid rgba(34,48,68,.9);
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700}
    main{
      max-width:1400px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 420px 1fr 420px;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(17,24,36,.9), rgba(15,22,32,.82));
      border:1px solid rgba(34,48,68,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 140px;
    }
    .card h2{
      margin:0;
      padding:12px 12px 10px;
      font-size:13px;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(34,48,68,.7);
      color: #dce8f7;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card h2 small{
      color:var(--muted);
      font-weight:600;
      font-size:11px;
    }
    .card .content{
      padding:12px;
    }
    .grid{
      display:grid;
      gap:10px;
    }
    .grid.cols2{grid-template-columns:1fr 1fr;}
    .grid.cols3{grid-template-columns:1fr 1fr 1fr;}
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    input, select, button, textarea{
      font-family:inherit;
    }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(34,48,68,.9);
      background: rgba(11,15,20,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(100,181,255,.9);
      box-shadow: 0 0 0 3px rgba(100,181,255,.15);
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:11px 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      transition: transform .06s ease, filter .2s ease, opacity .2s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px);}
    .btn.good{background: rgba(61,220,151,.16); color: #bdf8de; border:1px solid rgba(61,220,151,.45);}
    .btn.bad{background: rgba(255,91,110,.14); color: #ffd0d7; border:1px solid rgba(255,91,110,.45);}
    .btn.neutral{background: rgba(100,181,255,.14); color: #d4ebff; border:1px solid rgba(100,181,255,.45);}
    .btn.gray{background: rgba(159,176,195,.12); color: #e7eef7; border:1px solid rgba(159,176,195,.35);}
    .btn.warn{background: rgba(255,207,91,.12); color: #ffe8b2; border:1px solid rgba(255,207,91,.35);}
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px; font-weight:800;}
    .row{
      display:flex; gap:10px; align-items:center;
    }
    .row.wrap{flex-wrap:wrap;}
    .stat{
      display:flex; flex-direction:column; gap:2px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(11,15,20,.35);
      min-width: 0;
    }
    .stat .k{font-size:11px; color:var(--muted);}
    .stat .v{font-family:var(--mono); font-size:13px; font-weight:800; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .chartWrap{
      height: 520px;
      padding: 10px 12px 12px;
    }
    canvas{
      width:100%;
      height:100%;
      display:block;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(5,8,12,.65);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead th{
      text-align:left;
      color: var(--muted);
      font-size:11px;
      font-weight:700;
      padding:10px 8px;
      border-bottom:1px solid rgba(34,48,68,.7);
    }
    tbody td{
      padding:9px 8px;
      border-bottom:1px solid rgba(34,48,68,.35);
      vertical-align:top;
      font-family: var(--mono);
    }
    tbody tr:hover{
      background: rgba(100,181,255,.06);
    }
    .tag{
      font-family: var(--mono);
      font-size:11px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(34,48,68,.8);
      background: rgba(11,15,20,.35);
      color: var(--muted);
    }
    .tag.buy{border-color: rgba(61,220,151,.45); color:#bdf8de; background: rgba(61,220,151,.10);}
    .tag.sell{border-color: rgba(255,91,110,.45); color:#ffd0d7; background: rgba(255,91,110,.10);}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .log{
      height: 240px;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(11,15,20,.35);
      padding:10px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
    }
    .log div{padding:3px 0; border-bottom:1px dashed rgba(34,48,68,.35);}
    .log div:last-child{border-bottom:none;}
    .rightSticky{
      position:sticky;
      top:74px;
      height: calc(100vh - 88px);
      overflow:auto;
      padding-bottom: 16px;
    }
    .leftSticky{
      position:sticky;
      top:74px;
      height: calc(100vh - 88px);
      overflow:auto;
      padding-bottom: 16px;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }
    .sep{
      height:1px;
      background: rgba(34,48,68,.7);
      margin: 12px 0;
    }
    @media (max-width: 1220px){
      main{grid-template-columns: 1fr;}
      .rightSticky,.leftSticky{position:static; height:auto;}
      .chartWrap{height:420px;}
    }
  </style>
</head>

<body>
<header>
  <div class="row">
    <div class="title">
      <h1>Market Sandbox ‚Äî Control Mode üïπÔ∏è</h1>
      <div class="sub">–°–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä—ã–Ω–æ–∫ + Market/Limit + –ª–µ—Å—Ç–Ω–∏—Ü—ã —É—Ä–æ–≤–Ω–µ–π. –ë–µ–∑ TP/SL, —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å.</div>
    </div>

    <div class="row wrap">
      <div class="pill">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <b id="sym">NQ (sim)</b></div>
      <div class="pill">–¶–µ–Ω–∞: <b id="hdrPrice">‚Äî</b></div>
      <div class="pill">–ü–æ–∑–∏—Ü–∏—è: <b id="hdrPos">0</b></div>
      <div class="pill">Delta flow: <b id="hdrFlow">0</b></div>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: Controls -->
  <div class="leftSticky">
    <section class="card">
      <h2>–ú–∞—Ä–∫–µ—Ç-–∫–æ–Ω—Ç—Ä–æ–ª—å <small>–æ—Ä–¥–µ—Ä—ã</small></h2>
      <div class="content grid">
        <div class="grid cols2">
          <label>–ö–æ–ª-–≤–æ (qty)
            <input id="qty" type="number" step="1" min="1" value="1" />
          </label>
          <label>–ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (ticks)
            <input id="slip" type="number" step="1" min="0" value="1" />
          </label>
        </div>

        <div class="grid cols2">
          <button class="btn good" id="buyMkt">‚¨ÜÔ∏è Buy Market</button>
          <button class="btn bad" id="sellMkt">‚¨áÔ∏è Sell Market</button>
        </div>

        <div class="sep"></div>

        <div class="grid cols2">
          <label>–¢–∏–ø –ª–∏–º–∏—Ç–∫–∏
            <select id="limitSide">
              <option value="buy">Limit Buy</option>
              <option value="sell">Limit Sell</option>
            </select>
          </label>
          <label>–¶–µ–Ω–∞ –ª–∏–º–∏—Ç–∫–∏
            <input id="limitPrice" type="number" step="0.25" value="0" />
          </label>
        </div>
        <button class="btn neutral" id="placeLimit">‚ûï –ü–æ—Å—Ç–∞–≤–∏—Ç—å Limit</button>

        <div class="sep"></div>

        <div class="grid cols3">
          <label>–õ–µ—Å—Ç–Ω–∏—Ü–∞: side
            <select id="ladderSide">
              <option value="buy">Buy ladder</option>
              <option value="sell">Sell ladder</option>
            </select>
          </label>
          <label>Levels
            <input id="ladderLevels" type="number" step="1" min="1" value="8" />
          </label>
          <label>Step (pts)
            <input id="ladderStep" type="number" step="0.25" min="0.25" value="5" />
          </label>
        </div>
        <div class="grid cols2">
          <label>Start price
            <input id="ladderStart" type="number" step="0.25" value="0" />
          </label>
          <label>Qty per level
            <input id="ladderQty" type="number" step="1" min="1" value="1" />
          </label>
        </div>
        <button class="btn warn" id="placeLadder">ü™ú –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–µ—Å—Ç–Ω–∏—Ü—É</button>

        <div class="sep"></div>

        <div class="grid cols2">
          <label>–°–¥–≤–∏–≥ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–∫ (pts)
            <input id="shiftPts" type="number" step="0.25" value="1" />
          </label>
          <div class="grid cols2" style="align-items:end">
            <button class="btn gray small" id="shiftUp">‚¨ÜÔ∏è Shift +</button>
            <button class="btn gray small" id="shiftDn">‚¨áÔ∏è Shift ‚àí</button>
          </div>
        </div>

        <div class="grid cols2">
          <button class="btn gray" id="cancelAll">üßπ Cancel All</button>
          <button class="btn gray" id="flatten">üßØ Flatten (mkt)</button>
        </div>

        <div class="hint">
          <span class="mono">Flatten</span> –∑–∞–∫—Ä–æ–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ç–æ–º (–Ω–µ TP/SL ‚Äî –ø—Ä–æ—Å—Ç–æ ‚Äú–≤—ã–∫–ª—é—á–∏—Ç—å‚Äù).
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2>–î–≤–∏–∂–æ–∫ —Ä—ã–Ω–∫–∞ <small>–Ω–∞—Å—Ç—Ä–æ–π–∫–∏</small></h2>
      <div class="content grid">
        <div class="grid cols2">
          <label>Volatility (1‚Äì20)
            <input id="vol" type="number" step="1" min="1" max="20" value="8" />
          </label>
          <label>Liquidity (1‚Äì20)
            <input id="liq" type="number" step="1" min="1" max="20" value="10" />
          </label>
        </div>

        <div class="grid cols2">
          <label>Impact (0‚Äì20)
            <input id="impact" type="number" step="1" min="0" max="20" value="8" />
          </label>
          <label>Speed (ms)
            <input id="speed" type="number" step="10" min="20" value="80" />
          </label>
        </div>

        <div class="grid cols2">
          <label>Tick size
            <input id="tick" type="number" step="0.01" min="0.01" value="0.25" />
          </label>
          <label>Spread (ticks)
            <input id="spread" type="number" step="1" min="0" value="1" />
          </label>
        </div>

        <div class="grid cols2">
          <button class="btn neutral" id="pause">‚è∏Ô∏è Pause</button>
          <button class="btn neutral" id="reset">üîÅ Reset</button>
        </div>

        <div class="hint">
          <b>Impact</b> ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç–≤–æ–π net-flow –¥–≤–∏–≥–∞–µ—Ç —Ü–µ–Ω—É. <br/>
          <b>Liquidity</b> ‚Äî —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ —Ä—ã–Ω–∫—É (—á–µ–º –≤—ã—à–µ, —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ —Å–¥–≤–∏–Ω—É—Ç—å). <br/>
          –î–∞, —ç—Ç–æ ‚Äú–º–æ–¥–µ–ª—å‚Äù, –Ω–æ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç —Ç–æ, —á—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ: —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –¥–∞–≤–ª–µ–Ω–∏–µ. üòå
        </div>
      </div>
    </section>
  </div>

  <!-- CENTER: Chart -->
  <section class="card">
    <h2>–ì—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã <small>canvas</small></h2>
    <div class="chartWrap">
      <canvas id="chart" width="1200" height="520"></canvas>
    </div>
    <div class="content">
      <div class="row wrap">
        <div class="stat"><div class="k">Last</div><div class="v" id="stLast">‚Äî</div></div>
        <div class="stat"><div class="k">Bid / Ask</div><div class="v" id="stBA">‚Äî</div></div>
        <div class="stat"><div class="k">Net Position</div><div class="v" id="stPos">0</div></div>
        <div class="stat"><div class="k">Avg Price</div><div class="v" id="stAvg">‚Äî</div></div>
        <div class="stat"><div class="k">Flow (recent)</div><div class="v" id="stFlow">0</div></div>
        <div class="stat"><div class="k">Active Limits</div><div class="v" id="stLimits">0</div></div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Orders + Log -->
  <div class="rightSticky">
    <section class="card">
      <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç–∫–∏ <small>click ‚Üí cancel</small></h2>
      <div class="content" style="padding:0">
        <div style="max-height:320px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:70px">Side</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Left</th>
                <th style="width:90px">ID</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π <small>—á—Ç–æ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å</small></h2>
      <div class="content">
        <div class="log" id="log"></div>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn gray small" id="clearLog">üßΩ Clear log</button>
          <span class="hint">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–∞–π –ø–æ —Å—Ç—Ä–æ–∫–µ –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Äî –æ—Ç–º–µ–Ω–∞ –æ—Ä–¥–µ—Ä–∞.</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
(() => {
  // ===== Utilities
  const $ = (id) => document.getElementById(id);
  const now = () => new Date().toLocaleTimeString();
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const roundTo = (x, step) => Math.round(x / step) * step;

  // ===== State
  const state = {
    symbol: "NQ (sim)",
    tickSize: 0.25,
    spreadTicks: 1,
    volatility: 8,   // 1..20
    liquidity: 10,   // 1..20
    impact: 8,       // 0..20
    speedMs: 80,
    paused: false,

    // market variables
    price: 17000,
    velocity: 0,
    flow: 0,          // recent net order flow (decays)
    flowDecay: 0.92,  // each tick

    // user position (no PnL focus, but keep avg price for context)
    pos: 0,
    avg: null,

    // series for chart
    series: [],
    maxSeries: 450,

    // orders
    nextOrderId: 1,
    limits: [], // {id, side, price, qty, left, createdAt}
  };

  // ===== UI init
  $("sym").textContent = state.symbol;

  function log(msg, kind="") {
    const el = $("log");
    const line = document.createElement("div");
    line.innerHTML = `<span class="muted">[${now()}]</span> ${msg}`;
    if (kind === "good") line.style.color = "#bdf8de";
    if (kind === "bad")  line.style.color = "#ffd0d7";
    if (kind === "warn") line.style.color = "#ffe8b2";
    el.prepend(line);
  }

  function getBidAsk() {
    const spread = state.spreadTicks * state.tickSize;
    const mid = state.price;
    const bid = mid - spread/2;
    const ask = mid + spread/2;
    return { bid, ask };
  }

  function applyFill(side, qty, fillPrice, reason="") {
    // Update position + average price (simple weighted avg)
    const oldPos = state.pos;
    const newPos = oldPos + (side === "buy" ? qty : -qty);

    // Average price logic:
    // - If increasing same direction: weighted avg
    // - If reducing: avg unchanged unless flips through zero
    // - If flips: avg becomes fill price for remaining
    if (oldPos === 0) {
      state.avg = fillPrice;
    } else if (Math.sign(oldPos) === Math.sign(newPos) && newPos !== 0) {
      // same side add
      const oldAbs = Math.abs(oldPos);
      const newAbs = Math.abs(newPos);
      // qty added = newAbs - oldAbs
      const addQty = newAbs - oldAbs;
      if (addQty > 0) {
        state.avg = (state.avg * oldAbs + fillPrice * addQty) / newAbs;
      }
    } else if (newPos === 0) {
      state.avg = null;
    } else if (Math.sign(oldPos) !== Math.sign(newPos)) {
      // flip
      state.avg = fillPrice;
    }

    state.pos = newPos;

    // Add flow impact: buy positive, sell negative
    state.flow += (side === "buy" ? qty : -qty);

    const tag = side === "buy" ? "üü¢" : "üî¥";
    log(`${tag} FILLED <span class="mono">${side.toUpperCase()}</span> qty=<span class="mono">${qty}</span> @ <span class="mono">${fillPrice.toFixed(2)}</span> ${reason ? `<span class="muted">(${reason})</span>` : ""}`,
        side === "buy" ? "good" : "bad");
  }

  // ===== Order actions
  function marketOrder(side, qty, slipTicks) {
    const { bid, ask } = getBidAsk();
    // Simple slippage: extra ticks in direction
    const slip = slipTicks * state.tickSize;
    const fill = side === "buy" ? (ask + slip) : (bid - slip);
    applyFill(side, qty, fill, "market");
  }

  function placeLimit(side, price, qty) {
    price = roundTo(price, state.tickSize);
    const id = state.nextOrderId++;
    state.limits.push({
      id,
      side,
      price,
      qty,
      left: qty,
      createdAt: Date.now()
    });
    log(`‚ûï LIMIT <span class="mono">${side.toUpperCase()}</span> qty=<span class="mono">${qty}</span> @ <span class="mono">${price.toFixed(2)}</span> <span class="muted">(id=${id})</span>`, "warn");
    render();
  }

  function cancelOrder(id) {
    const idx = state.limits.findIndex(o => o.id === id);
    if (idx >= 0) {
      const o = state.limits[idx];
      state.limits.splice(idx, 1);
      log(`‚úñ CANCEL id=<span class="mono">${id}</span> (${o.side} @ ${o.price.toFixed(2)}, left=${o.left})`, "warn");
      render();
    }
  }

  function cancelAll() {
    const n = state.limits.length;
    state.limits = [];
    log(`üßπ Cancel All (${n} orders)`, "warn");
    render();
  }

  function shiftAll(deltaPts) {
    const delta = roundTo(deltaPts, state.tickSize);
    state.limits.forEach(o => o.price = roundTo(o.price + delta, state.tickSize));
    log(`‚Üï Shift all limits by <span class="mono">${delta.toFixed(2)}</span> pts`, "warn");
    render();
  }

  function flatten() {
    if (state.pos === 0) { log("üßØ Flatten: –ø–æ–∑–∏—Ü–∏—è —É–∂–µ 0", "warn"); return; }
    const qty = Math.abs(state.pos);
    const side = state.pos > 0 ? "sell" : "buy";
    marketOrder(side, qty, Number($("slip").value || 0));
    log("üßØ Flatten done", "warn");
    render();
  }

  function placeLadder(side, start, levels, step, qtyPerLevel) {
    start = roundTo(start, state.tickSize);
    step = Math.max(state.tickSize, step);
    step = roundTo(step, state.tickSize);

    for (let i = 0; i < levels; i++) {
      const p = side === "buy"
        ? start - i * step
        : start + i * step;
      placeLimit(side, p, qtyPerLevel);
    }
  }

  // ===== Matching engine for limits
  function matchLimits() {
    const { bid, ask } = getBidAsk();
    // For buy limits: fill if ask <= limitPrice (price touches/through)
    // For sell limits: fill if bid >= limitPrice
    // Partial fills: simulate with liquidity (higher = smaller partial)
    const liq = clamp(state.liquidity, 1, 20);

    // process in time order to feel fair-ish
    state.limits.sort((a,b)=>a.createdAt-b.createdAt);

    const filledIds = [];
    for (const o of state.limits) {
      if (o.left <= 0) { filledIds.push(o.id); continue; }

      const canFill = (o.side === "buy")
        ? (ask <= o.price)
        : (bid >= o.price);

      if (!canFill) continue;

      // Partial fill size: depends on liquidity + order left
      // low liq => larger chunks, high liq => smaller chunks
      const baseChunk = Math.max(1, Math.round(o.qty * (21 - liq) / 20));
      const chunk = Math.min(o.left, baseChunk);

      // Fill price: assume filled at limit price (you control liquidity),
      // could add slight improvement: fill at min(ask,limit) etc.
      const fillPrice = o.price;

      o.left -= chunk;
      applyFill(o.side, chunk, fillPrice, `limit id=${o.id}`);

      if (o.left <= 0) filledIds.push(o.id);
    }

    if (filledIds.length) {
      state.limits = state.limits.filter(o => !filledIds.includes(o.id));
    }
  }

  // ===== Market simulation
  function stepMarket() {
    if (state.paused) return;

    // decay flow
    state.flow *= state.flowDecay;

    // random component (volatility)
    const vol = clamp(state.volatility, 1, 20);
    // gaussian-ish random
    const r = (Math.random() + Math.random() + Math.random() + Math.random() - 2);
    const noise = r * (vol * state.tickSize * 0.35);

    // impact component
    const imp = clamp(state.impact, 0, 20);
    const liq = clamp(state.liquidity, 1, 20);

    // netFlow pressure, damped by liquidity
    const pressure = (state.flow) * (imp * state.tickSize * 0.06) * (1 / (liq * 0.35));

    // velocity with some mean reversion (keep stable-ish)
    state.velocity = (state.velocity * 0.85) + noise + pressure;

    // update price
    state.price = roundTo(state.price + state.velocity, state.tickSize);

    // keep series
    state.series.push(state.price);
    if (state.series.length > state.maxSeries) state.series.shift();

    // match limits after move
    matchLimits();

    render();
  }

  // ===== Chart (simple line + levels)
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");

  function drawChart() {
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // Background grid
    ctx.globalAlpha = 1;
    ctx.lineWidth = 1;

    ctx.strokeStyle = "rgba(34,48,68,0.55)";
    for (let i=1;i<8;i++){
      const y = (h/8)*i;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    }
    for (let i=1;i<12;i++){
      const x = (w/12)*i;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
    }

    const data = state.series;
    if (data.length < 2) return;

    let min = Math.min(...data);
    let max = Math.max(...data);

    // include limit levels in view
    for (const o of state.limits) { min = Math.min(min, o.price); max = Math.max(max, o.price); }

    const pad = (max-min) * 0.12 + state.tickSize * 20;
    min -= pad; max += pad;

    const xStep = w / (data.length - 1);
    const yOf = (p) => h - ((p - min) / (max - min)) * h;

    // Price line
    ctx.strokeStyle = "rgba(100,181,255,0.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for (let i=0;i<data.length;i++){
      const x = i * xStep;
      const y = yOf(data[i]);
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // current price marker
    const last = data[data.length-1];
    const yLast = yOf(last);
    ctx.fillStyle = "rgba(100,181,255,0.95)";
    ctx.beginPath();
    ctx.arc(w-8, yLast, 4, 0, Math.PI*2);
    ctx.fill();

    // draw bid/ask band
    const {bid, ask} = getBidAsk();
    const yBid = yOf(bid), yAsk = yOf(ask);
    ctx.fillStyle = "rgba(159,176,195,0.08)";
    ctx.fillRect(0, Math.min(yBid,yAsk), w, Math.abs(yBid-yAsk));

    // Limits lines
    for (const o of state.limits) {
      const y = yOf(o.price);
      ctx.strokeStyle = o.side === "buy" ? "rgba(61,220,151,0.65)" : "rgba(255,91,110,0.65)";
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();

      // label
      ctx.fillStyle = o.side === "buy" ? "rgba(61,220,151,0.9)" : "rgba(255,91,110,0.9)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      const text = `${o.side.toUpperCase()} ${o.price.toFixed(2)} (left ${o.left})`;
      ctx.fillText(text, 10, y - 6);
    }

    // Axis labels (min/max)
    ctx.fillStyle = "rgba(159,176,195,0.85)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText(`max ${max.toFixed(2)}`, 10, 16);
    ctx.fillText(`min ${min.toFixed(2)}`, 10, h - 10);
  }

  // ===== Render UI
  function renderOrdersTable() {
    const body = $("ordersBody");
    body.innerHTML = "";

    // Show sorted by price depending on side for readability
    const orders = [...state.limits].sort((a,b) => a.price - b.price);

    for (const o of orders) {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.title = "–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å";
      tr.addEventListener("click", () => cancelOrder(o.id));

      const sideTag = o.side === "buy"
        ? `<span class="tag buy">BUY</span>`
        : `<span class="tag sell">SELL</span>`;

      tr.innerHTML = `
        <td>${sideTag}</td>
        <td>${o.price.toFixed(2)}</td>
        <td>${o.qty}</td>
        <td>${o.left}</td>
        <td>${o.id}</td>
      `;
      body.appendChild(tr);
    }
  }

  function renderStats() {
    const { bid, ask } = getBidAsk();
    $("hdrPrice").textContent = state.price.toFixed(2);
    $("hdrPos").textContent = String(state.pos);
    $("hdrFlow").textContent = state.flow.toFixed(2);

    $("stLast").textContent = state.price.toFixed(2);
    $("stBA").textContent = `${bid.toFixed(2)} / ${ask.toFixed(2)}`;
    $("stPos").textContent = String(state.pos);
    $("stAvg").textContent = state.avg == null ? "‚Äî" : state.avg.toFixed(2);
    $("stFlow").textContent = state.flow.toFixed(2);
    $("stLimits").textContent = String(state.limits.length);
  }

  function render() {
    // sync settings
    state.tickSize = Number($("tick").value) || 0.25;
    state.spreadTicks = Math.max(0, Number($("spread").value || 0));
    state.volatility = clamp(Number($("vol").value || 8), 1, 20);
    state.liquidity = clamp(Number($("liq").value || 10), 1, 20);
    state.impact = clamp(Number($("impact").value || 8), 0, 20);
    state.speedMs = Math.max(20, Number($("speed").value || 80));

    renderStats();
    renderOrdersTable();
    drawChart();
  }

  // ===== Buttons
  $("buyMkt").addEventListener("click", () => {
    const qty = Math.max(1, Math.floor(Number($("qty").value || 1)));
    const slip = Math.max(0, Math.floor(Number($("slip").value || 0)));
    marketOrder("buy", qty, slip);
    render();
  });

  $("sellMkt").addEventListener("click", () => {
    const qty = Math.max(1, Math.floor(Number($("qty").value || 1)));
    const slip = Math.max(0, Math.floor(Number($("slip").value || 0)));
    marketOrder("sell", qty, slip);
    render();
  });

  $("placeLimit").addEventListener("click", () => {
    const side = $("limitSide").value;
    const qty = Math.max(1, Math.floor(Number($("qty").value || 1)));
    const price = Number($("limitPrice").value || 0);
    if (!Number.isFinite(price) || price <= 0) {
      log("‚ö†Ô∏è –í–≤–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –ª–∏–º–∏—Ç–∫–∏ (> 0).", "warn");
      return;
    }
    placeLimit(side, price, qty);
  });

  $("placeLadder").addEventListener("click", () => {
    const side = $("ladderSide").value;
    const levels = Math.max(1, Math.floor(Number($("ladderLevels").value || 1)));
    const step = Number($("ladderStep").value || state.tickSize);
    const qtyPer = Math.max(1, Math.floor(Number($("ladderQty").value || 1)));
    let start = Number($("ladderStart").value || 0);

    if (!Number.isFinite(start) || start <= 0) {
      // default start around current price for convenience
      start = state.price;
      $("ladderStart").value = start.toFixed(2);
    }
    placeLadder(side, start, levels, step, qtyPer);
  });

  $("cancelAll").addEventListener("click", cancelAll);
  $("flatten").addEventListener("click", flatten);

  $("shiftUp").addEventListener("click", () => {
    const pts = Number($("shiftPts").value || 0);
    if (!Number.isFinite(pts) || pts === 0) return;
    shiftAll(Math.abs(pts));
  });
  $("shiftDn").addEventListener("click", () => {
    const pts = Number($("shiftPts").value || 0);
    if (!Number.isFinite(pts) || pts === 0) return;
    shiftAll(-Math.abs(pts));
  });

  $("clearLog").addEventListener("click", () => $("log").innerHTML = "");

  $("pause").addEventListener("click", () => {
    state.paused = !state.paused;
    $("pause").textContent = state.paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
    log(state.paused ? "‚è∏Ô∏è Market paused" : "‚ñ∂Ô∏è Market resumed", "warn");
  });

  $("reset").addEventListener("click", () => {
    // hard reset
    state.price = 17000;
    state.velocity = 0;
    state.flow = 0;
    state.pos = 0;
    state.avg = null;
    state.limits = [];
    state.series = [];
    for (let i=0;i<60;i++) state.series.push(state.price);
    $("limitPrice").value = state.price.toFixed(2);
    $("ladderStart").value = state.price.toFixed(2);
    log("üîÅ Reset done", "warn");
    render();
  });

  // Convenience: init limit price with current
  function init() {
    // seed series
    for (let i=0;i<80;i++) state.series.push(state.price);
    $("limitPrice").value = state.price.toFixed(2);
    $("ladderStart").value = state.price.toFixed(2);
    render();
    log("–ì–æ—Ç–æ–≤–æ. –î–∞–≤–∏ —Ä—ã–Ω–æ–∫ –∫–∞–∫ —Ö–æ—á–µ—à—å üòà", "warn");
  }

  // ===== Timer loop (dynamic speed)
  let timer = null;
  function startLoop() {
    if (timer) clearInterval(timer);
    timer = setInterval(stepMarket, state.speedMs);
  }

  // update loop speed when input changes
  ["speed","vol","liq","impact","tick","spread"].forEach(id => {
    $(id).addEventListener("change", () => { render(); startLoop(); });
    $(id).addEventListener("input", () => { /* smooth-ish */ });
  });

  // quick keys
  window.addEventListener("keydown", (e) => {
    if (e.target && ["INPUT","SELECT","TEXTAREA"].includes(e.target.tagName)) return;

    if (e.key === " "){
      e.preventDefault();
      $("pause").click();
    }
    if (e.key.toLowerCase() === "b") $("buyMkt").click();
    if (e.key.toLowerCase() === "s") $("sellMkt").click();
    if (e.key.toLowerCase() === "c") $("cancelAll").click();
    if (e.key.toLowerCase() === "f") $("flatten").click();
  });

  init();
  startLoop();
})();
</script>
</body>
</html>
