<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Sandbox ‚Äî Smooth Candles</title>
  <style>
    :root{
      --bg:#0b0f14;
      --text:#e7eef7;
      --muted:#9fb0c3;
      --line:#223044;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 10% 10%, #101a2a 0%, var(--bg) 45%) fixed;
      color:var(--text);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,24,36,.85), rgba(11,15,20,.55));
      position:sticky; top:0; z-index:3;
      backdrop-filter: blur(8px);
    }
    header .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      max-width:1400px; margin:0 auto;
    }
    .title{display:flex; flex-direction:column; gap:2px;}
    .title h1{font-size:16px; margin:0; font-weight:700; letter-spacing:.2px;}
    .title .sub{font-size:12px; color:var(--muted);}

    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:8px 10px;
      background: rgba(17,24,36,.75);
      border:1px solid rgba(34,48,68,.9);
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700}

    main{
      max-width:1400px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 420px 1fr 420px;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(17,24,36,.9), rgba(15,22,32,.82));
      border:1px solid rgba(34,48,68,.9);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 140px;
    }
    .card h2{
      margin:0;
      padding:12px 12px 10px;
      font-size:13px;
      letter-spacing:.2px;
      border-bottom:1px solid rgba(34,48,68,.7);
      color: #dce8f7;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card h2 small{color:var(--muted); font-weight:600; font-size:11px;}
    .card .content{padding:12px;}
    .grid{display:grid; gap:10px;}
    .grid.cols2{grid-template-columns:1fr 1fr;}
    .grid.cols3{grid-template-columns:1fr 1fr 1fr;}

    label{display:flex; flex-direction:column; gap:6px; font-size:11px; color:var(--muted);}
    input, select, button{font-family:inherit;}
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(34,48,68,.9);
      background: rgba(11,15,20,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(100,181,255,.9);
      box-shadow: 0 0 0 3px rgba(100,181,255,.15);
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:11px 12px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
      background: rgba(159,176,195,.12);
      color:#e7eef7;
      border:1px solid rgba(159,176,195,.35);
      transition: transform .06s ease;
    }
    .btn:active{transform: translateY(1px);}
    .btn.good{background: rgba(61,220,151,.16); color: #bdf8de; border:1px solid rgba(61,220,151,.45);}
    .btn.bad{background: rgba(255,91,110,.14); color: #ffd0d7; border:1px solid rgba(255,91,110,.45);}
    .btn.neutral{background: rgba(100,181,255,.14); color: #d4ebff; border:1px solid rgba(100,181,255,.45);}
    .btn.warn{background: rgba(255,207,91,.12); color: #ffe8b2; border:1px solid rgba(255,207,91,.35);}
    .btn.small{padding:8px 10px; border-radius:10px; font-size:12px; font-weight:800;}

    .row{display:flex; gap:10px; align-items:center;}
    .row.wrap{flex-wrap:wrap;}

    .stat{
      display:flex; flex-direction:column; gap:2px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(11,15,20,.35);
      min-width: 0;
    }
    .stat .k{font-size:11px; color:var(--muted);}
    .stat .v{font-family:var(--mono); font-size:13px; font-weight:800; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}

    .chartTopBar{
      padding:12px;
      border-bottom:1px solid rgba(34,48,68,.7);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .chartTopBar .left{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .chartTopBar .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .miniField{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(11,15,20,.35);
      color: var(--muted);
      font-size:12px;
    }
    .miniField input{width:90px; padding:8px 8px; border-radius:10px; font-size:12px;}
    .miniField select{width:120px; padding:8px 8px; border-radius:10px; font-size:12px;}

    .chartWrap{height: 520px; padding: 10px 12px 12px;}
    canvas{
      width:100%;
      height:100%;
      display:block;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(5,8,12,.65);
    }

    table{width:100%; border-collapse:collapse; font-size:12px;}
    thead th{
      text-align:left;
      color: var(--muted);
      font-size:11px;
      font-weight:700;
      padding:10px 8px;
      border-bottom:1px solid rgba(34,48,68,.7);
    }
    tbody td{
      padding:9px 8px;
      border-bottom:1px solid rgba(34,48,68,.35);
      vertical-align:top;
      font-family: var(--mono);
    }
    tbody tr:hover{background: rgba(100,181,255,.06);}
    .tag{
      font-family: var(--mono);
      font-size:11px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid rgba(34,48,68,.8);
      background: rgba(11,15,20,.35);
      color: var(--muted);
    }
    .tag.buy{border-color: rgba(61,220,151,.45); color:#bdf8de; background: rgba(61,220,151,.10);}
    .tag.sell{border-color: rgba(255,91,110,.45); color:#ffd0d7; background: rgba(255,91,110,.10);}

    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .hint{font-size:12px; color: var(--muted); line-height:1.35;}
    .sep{height:1px; background: rgba(34,48,68,.7); margin: 12px 0;}

    .log{
      height: 240px;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(34,48,68,.7);
      background: rgba(11,15,20,.35);
      padding:10px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.35;
    }
    .log div{padding:3px 0; border-bottom:1px dashed rgba(34,48,68,.35);}
    .log div:last-child{border-bottom:none;}

    .rightSticky{
      position:sticky;
      top:74px;
      height: calc(100vh - 88px);
      overflow:auto;
      padding-bottom: 16px;
    }
    .leftSticky{
      position:sticky;
      top:74px;
      height: calc(100vh - 88px);
      overflow:auto;
      padding-bottom: 16px;
    }

    @media (max-width: 1220px){
      main{grid-template-columns: 1fr;}
      .rightSticky,.leftSticky{position:static; height:auto;}
      .chartWrap{height:420px;}
      .miniField input{width:110px;}
      .miniField select{width:140px;}
    }
  </style>
</head>

<body>
<header>
  <div class="row">
    <div class="title">
      <h1>Market Sandbox ‚Äî Smooth Candles üïπÔ∏è</h1>
      <div class="sub">–ü–ª–∞–≤–Ω–æ (60 FPS) + —Å–∏–º—É–ª—è—Ü–∏—è –º–∏–∫—Ä–æ—Ç–∏–∫–∞–º–∏ + —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã. –ë–µ–∑ TP/SL ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç—Ä–æ–ª—å.</div>
    </div>

    <div class="row wrap">
      <div class="pill">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <b id="sym">NQ (sim)</b></div>
      <div class="pill">–¶–µ–Ω–∞: <b id="hdrPrice">‚Äî</b></div>
      <div class="pill">–ü–æ–∑–∏—Ü–∏—è: <b id="hdrPos">0</b></div>
      <div class="pill">Flow: <b id="hdrFlow">0</b></div>
    </div>
  </div>
</header>

<main>
  <!-- LEFT -->
  <div class="leftSticky">
    <section class="card">
      <h2>–õ–∏–º–∏—Ç–∫–∏ –∏ —É—Ä–æ–≤–Ω–∏ <small>—á–∏—Å—Ç—ã–π control</small></h2>
      <div class="content grid">

        <div class="grid cols2">
          <label>–ö–æ–ª-–≤–æ (qty)
            <input id="qty" type="number" step="1" min="1" value="1" />
          </label>
          <label>–ü—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ (ticks)
            <input id="slip" type="number" step="1" min="0" value="1" />
          </label>
        </div>

        <div class="sep"></div>

        <div class="grid cols2">
          <label>–¢–∏–ø –ª–∏–º–∏—Ç–∫–∏
            <select id="limitSide">
              <option value="buy">Limit Buy</option>
              <option value="sell">Limit Sell</option>
            </select>
          </label>
          <label>–¶–µ–Ω–∞ –ª–∏–º–∏—Ç–∫–∏
            <input id="limitPrice" type="number" step="0.25" value="0" />
          </label>
        </div>
        <button class="btn neutral" id="placeLimit">‚ûï –ü–æ—Å—Ç–∞–≤–∏—Ç—å Limit</button>

        <div class="sep"></div>

        <div class="grid cols3">
          <label>–õ–µ—Å—Ç–Ω–∏—Ü–∞: side
            <select id="ladderSide">
              <option value="buy">Buy ladder</option>
              <option value="sell">Sell ladder</option>
            </select>
          </label>
          <label>Levels
            <input id="ladderLevels" type="number" step="1" min="1" value="8" />
          </label>
          <label>Step (pts)
            <input id="ladderStep" type="number" step="0.25" min="0.25" value="5" />
          </label>
        </div>
        <div class="grid cols2">
          <label>Start price
            <input id="ladderStart" type="number" step="0.25" value="0" />
          </label>
          <label>Qty per level
            <input id="ladderQty" type="number" step="1" min="1" value="1" />
          </label>
        </div>
        <button class="btn warn" id="placeLadder">ü™ú –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–µ—Å—Ç–Ω–∏—Ü—É</button>

        <div class="sep"></div>

        <div class="grid cols2">
          <label>–°–¥–≤–∏–≥ –≤—Å–µ—Ö –ª–∏–º–∏—Ç–æ–∫ (pts)
            <input id="shiftPts" type="number" step="0.25" value="1" />
          </label>
          <div class="grid cols2" style="align-items:end">
            <button class="btn small" id="shiftUp">‚¨ÜÔ∏è Shift +</button>
            <button class="btn small" id="shiftDn">‚¨áÔ∏è Shift ‚àí</button>
          </div>
        </div>

        <div class="grid cols2">
          <button class="btn" id="cancelAll">üßπ Cancel All</button>
          <button class="btn" id="flatten">üßØ Flatten (mkt)</button>
        </div>

        <div class="hint"><span class="mono">Flatten</span> ‚Äî –ø—Ä–æ—Å—Ç–æ ‚Äú–æ–±–Ω—É–ª–∏—Ç—å‚Äù –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ç–æ–º.</div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2>–î–≤–∏–∂–æ–∫ —Ä—ã–Ω–∫–∞ <small>–ø–ª–∞–≤–Ω–æ—Å—Ç—å –∏ TF</small></h2>
      <div class="content grid">
        <div class="grid cols2">
          <label>Volatility (1‚Äì20)
            <input id="vol" type="number" step="1" min="1" max="20" value="8" />
          </label>
          <label>Liquidity (1‚Äì20)
            <input id="liq" type="number" step="1" min="1" max="20" value="10" />
          </label>
        </div>

        <div class="grid cols2">
          <label>Impact (0‚Äì20)
            <input id="impact" type="number" step="1" min="0" max="20" value="8" />
          </label>
          <label>Sim ticks/sec (5‚Äì120)
            <input id="simHz" type="number" step="1" min="5" max="120" value="60" />
          </label>
        </div>

        <div class="grid cols2">
          <label>Tick size
            <input id="tick" type="number" step="0.01" min="0.01" value="0.25" />
          </label>
          <label>Spread (ticks)
            <input id="spread" type="number" step="1" min="0" value="1" />
          </label>
        </div>

        <div class="grid cols2">
          <label>–¢–∞–π–º—Ñ—Ä–µ–π–º (—Å–∏–º)
            <select id="timeframe">
              <option value="1s">1s</option>
              <option value="5s" selected>5s</option>
              <option value="15s">15s</option>
              <option value="1m">1m</option>
              <option value="5m">5m</option>
            </select>
          </label>
          <label>–°–≤–µ—á–µ–π –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            <input id="maxBars" type="number" step="10" min="60" value="220" />
          </label>
        </div>

        <div class="grid cols2">
          <button class="btn neutral" id="pause">‚è∏Ô∏è Pause</button>
          <button class="btn neutral" id="reset">üîÅ Reset</button>
        </div>

        <div class="hint">
          <b>Sim ticks/sec</b> ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–≤–Ω–æ/–±—ã—Å—Ç—Ä–æ –¥–≤–∏–≥–∞–µ—Ç—Å—è —Ü–µ–Ω–∞. <br/>
          <b>–¢–∞–π–º—Ñ—Ä–µ–π–º</b> ‚Äî —Å–∫–æ–ª—å–∫–æ ‚Äú—Ç–∏–∫-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π‚Äù —Å–æ–±–∏—Ä–∞–µ–º –≤ –æ–¥–Ω—É —Å–≤–µ—á—É. ‚úÖ
        </div>
      </div>
    </section>
  </div>

  <!-- CENTER -->
  <section class="card">
    <h2>–ì—Ä–∞—Ñ–∏–∫ (—Å–≤–µ—á–∏) <small>market —Ä—è–¥–æ–º</small></h2>

    <div class="chartTopBar">
      <div class="left">
        <button class="btn good" id="buyMktTop">‚¨ÜÔ∏è Buy Market</button>
        <button class="btn bad" id="sellMktTop">‚¨áÔ∏è Sell Market</button>

        <div class="miniField">qty <input id="qtyTop" type="number" step="1" min="1" value="1" /></div>
        <div class="miniField">slip <input id="slipTop" type="number" step="1" min="0" value="1" /></div>
      </div>

      <div class="right">
        <div class="miniField mono">B=Buy S=Sell Space=Pause C=CancelAll F=Flatten</div>
      </div>
    </div>

    <div class="chartWrap">
      <canvas id="chart" width="1200" height="520"></canvas>
    </div>

    <div class="content">
      <div class="row wrap">
        <div class="stat"><div class="k">Last</div><div class="v" id="stLast">‚Äî</div></div>
        <div class="stat"><div class="k">Bid / Ask</div><div class="v" id="stBA">‚Äî</div></div>
        <div class="stat"><div class="k">Net Position</div><div class="v" id="stPos">0</div></div>
        <div class="stat"><div class="k">Avg Price</div><div class="v" id="stAvg">‚Äî</div></div>
        <div class="stat"><div class="k">Flow (recent)</div><div class="v" id="stFlow">0</div></div>
        <div class="stat"><div class="k">Active Limits</div><div class="v" id="stLimits">0</div></div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <div class="rightSticky">
    <section class="card">
      <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç–∫–∏ <small>click ‚Üí cancel</small></h2>
      <div class="content" style="padding:0">
        <div style="max-height:320px; overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="width:70px">Side</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Left</th>
                <th style="width:90px">ID</th>
              </tr>
            </thead>
            <tbody id="ordersBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2>–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π <small>fills/cancel</small></h2>
      <div class="content">
        <div class="log" id="log"></div>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn small" id="clearLog">üßΩ Clear log</button>
          <span class="hint">–ö–ª–∏–∫ –ø–æ –æ—Ä–¥–µ—Ä—É ‚Äî –æ—Ç–º–µ–Ω–∞.</span>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const now = () => new Date().toLocaleTimeString();
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const roundTo = (x, step) => Math.round(x / step) * step;

  const state = {
    symbol: "NQ (sim)",

    tickSize: 0.25,
    spreadTicks: 1,
    volatility: 8,
    liquidity: 10,
    impact: 8,

    simHz: 60,          // —Å–∏–º-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
    paused: false,

    price: 17000,
    velocity: 0,
    flow: 0,
    flowDecay: 0.94,    // —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, —á—Ç–æ–±—ã –±—ã–ª–æ ‚Äú–∂–∏–≤–µ–µ‚Äù

    pos: 0,
    avg: null,

    // —Å–≤–µ—á–∏
    bars: [],               // {o,h,l,c}
    maxBars: 220,
    barTicks: 12,           // –±—É–¥–µ—Ç –≤—ã—Å—Ç–∞–≤–ª—è—Ç—å—Å—è –∏–∑ TF
    _barCounter: 0,
    _curBar: null,

    // –ª–∏–º–∏—Ç–∫–∏
    nextOrderId: 1,
    limits: [], // {id, side, price, qty, left, createdAt}
  };

  $("sym").textContent = state.symbol;

  function log(msg, kind="") {
    const el = $("log");
    const line = document.createElement("div");
    line.innerHTML = `<span class="muted">[${now()}]</span> ${msg}`;
    if (kind === "good") line.style.color = "#bdf8de";
    if (kind === "bad")  line.style.color = "#ffd0d7";
    if (kind === "warn") line.style.color = "#ffe8b2";
    el.prepend(line);
  }

  function getBidAsk() {
    const spread = state.spreadTicks * state.tickSize;
    const mid = state.price;
    return { bid: mid - spread/2, ask: mid + spread/2 };
  }

  function applyFill(side, qty, fillPrice, reason="") {
    const oldPos = state.pos;
    const newPos = oldPos + (side === "buy" ? qty : -qty);

    if (oldPos === 0) state.avg = fillPrice;
    else if (Math.sign(oldPos) === Math.sign(newPos) && newPos !== 0) {
      const oldAbs = Math.abs(oldPos);
      const newAbs = Math.abs(newPos);
      const addQty = newAbs - oldAbs;
      if (addQty > 0) state.avg = (state.avg * oldAbs + fillPrice * addQty) / newAbs;
    } else if (newPos === 0) state.avg = null;
    else if (Math.sign(oldPos) !== Math.sign(newPos)) state.avg = fillPrice;

    state.pos = newPos;
    state.flow += (side === "buy" ? qty : -qty);

    const tag = side === "buy" ? "üü¢" : "üî¥";
    log(`${tag} FILLED <span class="mono">${side.toUpperCase()}</span> qty=<span class="mono">${qty}</span> @ <span class="mono">${fillPrice.toFixed(2)}</span> ${reason ? `<span class="muted">(${reason})</span>` : ""}`,
      side === "buy" ? "good" : "bad"
    );
  }

  function marketOrder(side, qty, slipTicks) {
    const { bid, ask } = getBidAsk();
    const slip = slipTicks * state.tickSize;
    const fill = side === "buy" ? (ask + slip) : (bid - slip);
    applyFill(side, qty, fill, "market");
  }

  function placeLimit(side, price, qty) {
    price = roundTo(price, state.tickSize);
    const id = state.nextOrderId++;
    state.limits.push({ id, side, price, qty, left: qty, createdAt: Date.now() });
    log(`‚ûï LIMIT <span class="mono">${side.toUpperCase()}</span> qty=<span class="mono">${qty}</span> @ <span class="mono">${price.toFixed(2)}</span> <span class="muted">(id=${id})</span>`, "warn");
  }

  function cancelOrder(id) {
    const idx = state.limits.findIndex(o => o.id === id);
    if (idx >= 0) {
      const o = state.limits[idx];
      state.limits.splice(idx, 1);
      log(`‚úñ CANCEL id=<span class="mono">${id}</span> (${o.side} @ ${o.price.toFixed(2)}, left=${o.left})`, "warn");
    }
  }

  function cancelAll() {
    const n = state.limits.length;
    state.limits = [];
    log(`üßπ Cancel All (${n} orders)`, "warn");
  }

  function shiftAll(deltaPts) {
    const delta = roundTo(deltaPts, state.tickSize);
    state.limits.forEach(o => o.price = roundTo(o.price + delta, state.tickSize));
    log(`‚Üï Shift all limits by <span class="mono">${delta.toFixed(2)}</span> pts`, "warn");
  }

  function flatten() {
    if (state.pos === 0) { log("üßØ Flatten: –ø–æ–∑–∏—Ü–∏—è —É–∂–µ 0", "warn"); return; }
    const qty = Math.abs(state.pos);
    const side = state.pos > 0 ? "sell" : "buy";
    marketOrder(side, qty, getSlip());
    log("üßØ Flatten done", "warn");
  }

  function placeLadder(side, start, levels, step, qtyPerLevel) {
    start = roundTo(start, state.tickSize);
    step = roundTo(Math.max(state.tickSize, step), state.tickSize);
    for (let i = 0; i < levels; i++) {
      const p = side === "buy" ? start - i * step : start + i * step;
      placeLimit(side, p, qtyPerLevel);
    }
  }

  function matchLimits() {
    const { bid, ask } = getBidAsk();
    const liq = clamp(state.liquidity, 1, 20);

    state.limits.sort((a,b)=>a.createdAt-b.createdAt);

    const filledIds = [];
    for (const o of state.limits) {
      if (o.left <= 0) { filledIds.push(o.id); continue; }

      const canFill = (o.side === "buy") ? (ask <= o.price) : (bid >= o.price);
      if (!canFill) continue;

      // partial fill
      const baseChunk = Math.max(1, Math.round(o.qty * (21 - liq) / 20));
      const chunk = Math.min(o.left, baseChunk);

      o.left -= chunk;
      applyFill(o.side, chunk, o.price, `limit id=${o.id}`);

      if (o.left <= 0) filledIds.push(o.id);
    }
    if (filledIds.length) state.limits = state.limits.filter(o => !filledIds.includes(o.id));
  }

  function updateCandlesWithPrice(p) {
    if (!state._curBar) {
      state._curBar = { o:p, h:p, l:p, c:p };
      state._barCounter = 0;
      return;
    }
    state._curBar.h = Math.max(state._curBar.h, p);
    state._curBar.l = Math.min(state._curBar.l, p);
    state._curBar.c = p;

    state._barCounter++;
    if (state._barCounter >= state.barTicks) {
      state.bars.push(state._curBar);
      if (state.bars.length > state.maxBars) state.bars.shift();
      state._curBar = { o:p, h:p, l:p, c:p };
      state._barCounter = 0;
    }
  }

  // ===== Smooth sim tick (small step)
  function stepSimulationOnce() {
    // decay flow
    state.flow *= state.flowDecay;

    const vol = clamp(state.volatility, 1, 20);
    // gaussian-ish
    const r = (Math.random()+Math.random()+Math.random()+Math.random()-2);
    const noise = r * (vol * state.tickSize * 0.18);

    const imp = clamp(state.impact, 0, 20);
    const liq = clamp(state.liquidity, 1, 20);
    const pressure = (state.flow) * (imp * state.tickSize * 0.045) * (1 / (liq * 0.40));

    // smoother velocity
    state.velocity = (state.velocity * 0.92) + noise + pressure;

    // smoother price update
    state.price = roundTo(state.price + state.velocity, state.tickSize);

    updateCandlesWithPrice(state.price);
    matchLimits();
  }

  // ===== Chart (candles)
  const canvas = $("chart");
  const ctx = canvas.getContext("2d");

  function drawChart() {
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    // grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(34,48,68,0.55)";
    for (let i=1;i<8;i++){
      const y = (h/8)*i;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
    }
    for (let i=1;i<12;i++){
      const x = (w/12)*i;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
    }

    if (!state.bars || state.bars.length < 2) return;

    let min = Infinity, max = -Infinity;
    for (const b of state.bars) { min = Math.min(min, b.l); max = Math.max(max, b.h); }
    // include current unfinished bar for nicer view
    if (state._curBar) { min = Math.min(min, state._curBar.l); max = Math.max(max, state._curBar.h); }
    for (const o of state.limits) { min = Math.min(min, o.price); max = Math.max(max, o.price); }

    const pad = (max-min) * 0.12 + state.tickSize * 20;
    min -= pad; max += pad;

    const yOf = (p) => h - ((p - min) / (max - min)) * h;

    // bid/ask band
    const {bid, ask} = getBidAsk();
    const yBid = yOf(bid), yAsk = yOf(ask);
    ctx.fillStyle = "rgba(159,176,195,0.08)";
    ctx.fillRect(0, Math.min(yBid,yAsk), w, Math.abs(yBid-yAsk));

    // render bars + current bar (as last)
    const bars = [...state.bars];
    if (state._curBar) bars.push(state._curBar);

    const n = bars.length;
    const candleW = Math.max(3, Math.floor(w / (n + 10)));
    const gap = Math.max(1, Math.floor(candleW * 0.35));
    const step = candleW + gap;
    const totalW = step * n;
    const xStart = Math.max(6, Math.floor((w - totalW) / 2));

    for (let i=0; i<n; i++) {
      const b = bars[i];
      const x = xStart + i * step;
      const yO = yOf(b.o), yH = yOf(b.h), yL = yOf(b.l), yC = yOf(b.c);
      const up = b.c >= b.o;

      // wick
      ctx.strokeStyle = up ? "rgba(61,220,151,0.85)" : "rgba(255,91,110,0.85)";
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(x + candleW/2, yH);
      ctx.lineTo(x + candleW/2, yL);
      ctx.stroke();

      // body
      const bodyTop = Math.min(yO, yC);
      const bodyH = Math.max(2, Math.abs(yC - yO));
      ctx.fillStyle = up ? "rgba(61,220,151,0.30)" : "rgba(255,91,110,0.28)";
      ctx.strokeStyle = up ? "rgba(61,220,151,0.95)" : "rgba(255,91,110,0.95)";
      ctx.lineWidth = 1.5;
      ctx.fillRect(x, bodyTop, candleW, bodyH);
      ctx.strokeRect(x, bodyTop, candleW, bodyH);
    }

    // limits
    for (const o of state.limits) {
      const y = yOf(o.price);
      ctx.strokeStyle = o.side === "buy" ? "rgba(61,220,151,0.65)" : "rgba(255,91,110,0.65)";
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();

      ctx.fillStyle = o.side === "buy" ? "rgba(61,220,151,0.9)" : "rgba(255,91,110,0.9)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(`${o.side.toUpperCase()} ${o.price.toFixed(2)} (left ${o.left})`, 10, y - 6);
    }

    // labels
    ctx.fillStyle = "rgba(159,176,195,0.85)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText(`max ${max.toFixed(2)}`, 10, 16);
    ctx.fillText(`min ${min.toFixed(2)}`, 10, h - 10);

    // last marker at current price
    const yLast = yOf(state.price);
    ctx.fillStyle = "rgba(100,181,255,0.95)";
    ctx.beginPath();
    ctx.arc(w-10, yLast, 4, 0, Math.PI*2);
    ctx.fill();
  }

  function renderOrdersTable() {
    const body = $("ordersBody");
    body.innerHTML = "";
    const orders = [...state.limits].sort((a,b) => a.price - b.price);

    for (const o of orders) {
      const tr = document.createElement("tr");
      tr.style.cursor = "pointer";
      tr.title = "–ù–∞–∂–º–∏ —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å";
      tr.addEventListener("click", () => cancelOrder(o.id));

      const sideTag = o.side === "buy"
        ? `<span class="tag buy">BUY</span>`
        : `<span class="tag sell">SELL</span>`;

      tr.innerHTML = `
        <td>${sideTag}</td>
        <td>${o.price.toFixed(2)}</td>
        <td>${o.qty}</td>
        <td>${o.left}</td>
        <td>${o.id}</td>
      `;
      body.appendChild(tr);
    }
  }

  function renderStats() {
    const { bid, ask } = getBidAsk();
    $("hdrPrice").textContent = state.price.toFixed(2);
    $("hdrPos").textContent = String(state.pos);
    $("hdrFlow").textContent = state.flow.toFixed(2);

    $("stLast").textContent = state.price.toFixed(2);
    $("stBA").textContent = `${bid.toFixed(2)} / ${ask.toFixed(2)}`;
    $("stPos").textContent = String(state.pos);
    $("stAvg").textContent = state.avg == null ? "‚Äî" : state.avg.toFixed(2);
    $("stFlow").textContent = state.flow.toFixed(2);
    $("stLimits").textContent = String(state.limits.length);
  }

  function syncTopFromLeft() {
    if (document.activeElement !== $("qtyTop")) $("qtyTop").value = $("qty").value;
    if (document.activeElement !== $("slipTop")) $("slipTop").value = $("slip").value;
  }
  function syncLeftFromTop() {
    $("qty").value = String(Math.max(1, Math.floor(Number($("qtyTop").value || 1))));
    $("slip").value = String(Math.max(0, Math.floor(Number($("slipTop").value || 0))));
  }
  function getQty() {
    const q = Number($("qtyTop").value || $("qty").value || 1);
    return Math.max(1, Math.floor(q));
  }
  function getSlip() {
    const s = Number($("slipTop").value || $("slip").value || 0);
    return Math.max(0, Math.floor(s));
  }

  // ===== Timeframe mapping
  function timeframeToBarTicks(tf, simHz) {
    // –°–º—ã—Å–ª: —Å–∫–æ–ª—å–∫–æ —Å–∏–º-—Ç–∏–∫–æ–≤ = 1 –±–∞—Ä.
    // 1s = simHz —Ç–∏–∫–æ–≤; 5s=5*simHz; 15s=15*simHz; 1m=60*simHz; 5m=300*simHz
    if (tf === "1s") return Math.max(2, Math.round(1 * simHz));
    if (tf === "5s") return Math.max(2, Math.round(5 * simHz));
    if (tf === "15s") return Math.max(2, Math.round(15 * simHz));
    if (tf === "1m") return Math.max(2, Math.round(60 * simHz));
    if (tf === "5m") return Math.max(2, Math.round(300 * simHz));
    return Math.max(2, Math.round(5 * simHz));
  }

  function applySettingsFromUI() {
    state.tickSize = Number($("tick").value) || 0.25;
    state.spreadTicks = Math.max(0, Number($("spread").value || 0));
    state.volatility = clamp(Number($("vol").value || 8), 1, 20);
    state.liquidity = clamp(Number($("liq").value || 10), 1, 20);
    state.impact = clamp(Number($("impact").value || 8), 0, 20);
    state.simHz = clamp(Number($("simHz").value || 60), 5, 120);
    state.maxBars = Math.max(60, Math.floor(Number($("maxBars").value || 220)));

    const tf = $("timeframe").value;
    state.barTicks = timeframeToBarTicks(tf, state.simHz);

    // trim bars
    if (state.bars.length > state.maxBars) state.bars = state.bars.slice(state.bars.length - state.maxBars);

    syncTopFromLeft();
  }

  function renderAll() {
    applySettingsFromUI();
    renderStats();
    renderOrdersTable();
    drawChart();
  }

  // ===== Buttons
  function buyMarket() { syncLeftFromTop(); marketOrder("buy", getQty(), getSlip()); }
  function sellMarket() { syncLeftFromTop(); marketOrder("sell", getQty(), getSlip()); }

  $("buyMktTop").addEventListener("click", () => { buyMarket(); renderAll(); });
  $("sellMktTop").addEventListener("click", () => { sellMarket(); renderAll(); });

  $("qtyTop").addEventListener("input", syncLeftFromTop);
  $("slipTop").addEventListener("input", syncLeftFromTop);

  $("placeLimit").addEventListener("click", () => {
    const side = $("limitSide").value;
    const qty = getQty();
    const price = Number($("limitPrice").value || 0);
    if (!Number.isFinite(price) || price <= 0) { log("‚ö†Ô∏è –í–≤–µ–¥–∏ —Ü–µ–Ω—É –ª–∏–º–∏—Ç–∫–∏ (> 0).", "warn"); return; }
    placeLimit(side, price, qty);
    renderAll();
  });

  $("placeLadder").addEventListener("click", () => {
    const side = $("ladderSide").value;
    const levels = Math.max(1, Math.floor(Number($("ladderLevels").value || 1)));
    const step = Number($("ladderStep").value || state.tickSize);
    const qtyPer = Math.max(1, Math.floor(Number($("ladderQty").value || 1)));
    let start = Number($("ladderStart").value || 0);
    if (!Number.isFinite(start) || start <= 0) { start = state.price; $("ladderStart").value = start.toFixed(2); }
    placeLadder(side, start, levels, step, qtyPer);
    renderAll();
  });

  $("cancelAll").addEventListener("click", () => { cancelAll(); renderAll(); });
  $("flatten").addEventListener("click", () => { flatten(); renderAll(); });

  $("shiftUp").addEventListener("click", () => { const pts = Number($("shiftPts").value||0); if (pts) { shiftAll(Math.abs(pts)); renderAll(); } });
  $("shiftDn").addEventListener("click", () => { const pts = Number($("shiftPts").value||0); if (pts) { shiftAll(-Math.abs(pts)); renderAll(); } });

  $("clearLog").addEventListener("click", () => $("log").innerHTML = "");

  $("pause").addEventListener("click", () => {
    state.paused = !state.paused;
    $("pause").textContent = state.paused ? "‚ñ∂Ô∏è Resume" : "‚è∏Ô∏è Pause";
    log(state.paused ? "‚è∏Ô∏è Market paused" : "‚ñ∂Ô∏è Market resumed", "warn");
  });

  $("reset").addEventListener("click", () => {
    state.price = 17000;
    state.velocity = 0;
    state.flow = 0;
    state.pos = 0;
    state.avg = null;
    state.limits = [];
    state.bars = [];
    state._curBar = { o: state.price, h: state.price, l: state.price, c: state.price };
    state._barCounter = 0;

    $("limitPrice").value = state.price.toFixed(2);
    $("ladderStart").value = state.price.toFixed(2);
    $("qty").value = "1"; $("slip").value = "1";
    $("qtyTop").value = "1"; $("slipTop").value = "1";

    log("üîÅ Reset done", "warn");
    renderAll();
  });

  // ===== Hotkeys
  window.addEventListener("keydown", (e) => {
    if (e.target && ["INPUT","SELECT"].includes(e.target.tagName)) return;
    if (e.key === " ") { e.preventDefault(); $("pause").click(); }
    if (e.key.toLowerCase() === "b") { buyMarket(); renderAll(); }
    if (e.key.toLowerCase() === "s") { sellMarket(); renderAll(); }
    if (e.key.toLowerCase() === "c") { $("cancelAll").click(); }
    if (e.key.toLowerCase() === "f") { $("flatten").click(); }
  });

  // ===== Smooth main loop (rAF)
  let lastTs = performance.now();
  let acc = 0;

  function loop(ts) {
    const dt = (ts - lastTs) / 1000;
    lastTs = ts;

    applySettingsFromUI();

    // fixed step
    const step = 1 / state.simHz;
    if (!state.paused) {
      acc += dt;
      // safety: avoid spiral if tab lag
      acc = Math.min(acc, 0.25);

      while (acc >= step) {
        stepSimulationOnce();
        acc -= step;
      }
    }

    // render every frame for smooth feel
    renderStats();
    renderOrdersTable();
    drawChart();

    requestAnimationFrame(loop);
  }

  // init
  function init() {
    state._curBar = { o: state.price, h: state.price, l: state.price, c: state.price };
    state._barCounter = 0;
    state.bars = [];

    $("limitPrice").value = state.price.toFixed(2);
    $("ladderStart").value = state.price.toFixed(2);

    renderAll();
    log("–ì–æ—Ç–æ–≤–æ. –¢–µ–ø–µ—Ä—å –¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞–≤–Ω–æ–µ, TF –µ—Å—Ç—å. üòà", "warn");
    requestAnimationFrame(loop);
  }

  // react to settings changes
  ["vol","liq","impact","simHz","tick","spread","timeframe","maxBars"].forEach(id => {
    $(id).addEventListener("change", renderAll);
  });

  init();
})();
</script>
</body>
</html>
